<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Restablecer contraseña - MindConnectAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
            background: linear-gradient(135deg,#f3f6ff,#f6fbf7); 
            min-height:100vh; display:flex; align-items:center; 
            justify-content:center;padding:24px 
        }
        .card { 
            background:#fff; 
            padding:24px; border-radius:12px; 
            width:100%; 
            max-width:480px; 
            box-shadow:0 8px 30px rgba(2,6,23,0.08) 
        }
    </style>
</head>
<body>
<div class="card">
    <h2 class="text-2xl font-semibold mb-3">Restablecer contraseña</h2>
    <p class="text-sm mb-4">Introduce tu nueva contraseña. El token debe estar presente en la URL.</p>
    <div>
        <label class="block text-sm font-medium">Nueva contraseña</label>
        <input id="newPassword" type="password" class="w-full mt-2 p-3 border rounded" placeholder="Nueva contraseña" />
        <div id="errNew" class="text-sm text-red-600 mt-2"></div>
    </div>
    <div class="mt-4">
        <label class="block text-sm font-medium">Confirmar contraseña</label>
        <input id="confirmPassword" type="password" class="w-full mt-2 p-3 border rounded" placeholder="Repite la contraseña" />
        <div id="errConfirm" class="text-sm text-red-600 mt-2"></div>
    </div>
    <div id="globalMsg" class="text-sm mt-4"></div>
        <div class="mt-6 flex gap-3">
        <button id="submitBtn" class="bg-green-500 text-white px-4 py-2 rounded">Actualizar contraseña</button>
        <a href="index.html" class="px-4 py-2 rounded border">Volver</a>
    </div>
</div>

<script>
    function qs(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    const token = qs('token');
    const newPasswordEl = document.getElementById('newPassword');
    const confirmEl = document.getElementById('confirmPassword');
    const errNew = document.getElementById('errNew');
    const errConfirm = document.getElementById('errConfirm');
    const globalMsg = document.getElementById('globalMsg');
    const submitBtn = document.getElementById('submitBtn');

    function validPassword(pw) {
        return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/.test(pw);
    }

    if (!token) {
        globalMsg.textContent = 'Token no encontrado en la URL. Usa el enlace enviado por email.';
        globalMsg.style.color = 'red';
        submitBtn.disabled = true;
    }

    submitBtn.addEventListener('click', async () => {
        errNew.textContent = '';
        errConfirm.textContent = '';
        globalMsg.textContent = '';

        const pw = newPasswordEl.value;
        const pw2 = confirmEl.value;

        if (!pw || !validPassword(pw)) { errNew.textContent = 'Contraseña inválida. Mínimo 8 caracteres, mayúscula, minúscula y número.'; return }
        if (pw !== pw2) { errConfirm.textContent = 'Las contraseñas no coinciden.'; return }

        try {
        const res = await fetch('http://localhost:3000/auth/reset-password', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token, newPassword: pw })
        });
        const data = await res.json();
        if (!res.ok) { globalMsg.textContent = data.message || 'Error al actualizar contraseña.'; globalMsg.style.color = 'red'; return }
        globalMsg.textContent = data.message || 'Contraseña actualizada. Redirigiendo al login...'; globalMsg.style.color = 'green';
        setTimeout(() => { window.location.href = 'index.html'; }, 1400);
        } catch (err) {
        console.error(err);
        globalMsg.textContent = 'Error de red. Intenta nuevamente.'; globalMsg.style.color = 'red';
        }
    });
</script>
</body>
</html>
